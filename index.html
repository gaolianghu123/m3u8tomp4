<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>M3U8 TS 下载测试（零成本）</title>
</head>
<body>
<h2>M3U8 TS 下载测试（零成本）</h2>

<p>点击按钮下载一个视频分片（测试广告/用户操作）</p>
<button id="downloadBtn">下载 TS 分片</button>
<br><br>

<!-- 下载链接 -->
<a id="download" style="display:none;">点击下载视频分片</a>

<!-- 日志 -->
<pre id="log" style="width:400px;height:200px;overflow:auto;border:1px solid #ccc;"></pre>

<script>
const logEl = document.getElementById('log');
const downloadLink = document.getElementById('download');

document.getElementById('downloadBtn').addEventListener('click', async () => {
  logEl.textContent = '';
  downloadLink.style.display = 'none';

  try {
    logEl.textContent += '获取视频分片链接...\n';

    // 这里用你自己的 Cloudflare Worker 代理 m3u8
    // Worker 需要返回第一个 TS 文件的完整 URL
    const m3u8Url = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
    const proxyUrl = 'https://m3u8tomp4worker.136401367.workers.dev/?url=' + encodeURIComponent(m3u8Url);

    // Worker 返回第一个 TS 分片 URL（假设 Worker 已经解析 m3u8）
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error('Worker 代理无法访问 m3u8');

    const tsUrl = await res.text(); // Worker 返回第一个 TS 的 URL
    logEl.textContent += '分片 URL 获取成功: ' + tsUrl + '\n';

    // 创建下载链接
    downloadLink.href = tsUrl;
    downloadLink.download = 'video_segment.ts';
    downloadLink.style.display = 'block';
    downloadLink.innerText = '点击下载 TS 分片';
    logEl.textContent += '可以点击下载 TS 分片。\n';

  } catch (err) {
    logEl.textContent += '获取失败: ' + err.message + '\n';
    console.error(err);
  }
});
</script>
</body>
</html>
