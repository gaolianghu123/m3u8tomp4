<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 转 MP4 在线转换器</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 10px 0; color: #666; }
        #progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; display: none; }
        #progress-bar { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        a { display: block; margin-top: 10px; color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <h1>M3U8 转 MP4 在线转换器</h1>
    <p>输入 M3U8 URL（确保支持 CORS），点击转换。转换后可下载 MP4 文件。</p>
    <input type="url" id="m3u8Url" placeholder="例如: https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" required>
    <br><br>
    <button id="convertBtn">开始转换</button>
    <div id="progress">
        <div id="progress-bar"></div>
    </div>
    <p id="status">就绪 - 支持浏览器端转换，无需上传文件</p>
    <a id="downloadLink" style="display: none;">下载 MP4 文件</a>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();
        const statusEl = document.getElementById('status');
        const convertBtn = document.getElementById('convertBtn');
        const downloadLink = document.getElementById('downloadLink');
        const m3u8UrlEl = document.getElementById('m3u8Url');
        const progressEl = document.getElementById('progress');
        const progressBarEl = document.getElementById('progress-bar');

        // FFmpeg 进度监听（简化版）
        ffmpeg.on('progress', ({ progress }) => {
            progressBarEl.style.width = `${progress * 100}%`;
        });

        convertBtn.addEventListener('click', async () => {
            const m3u8Url = m3u8UrlEl.value.trim();
            if (!m3u8Url) {
                alert('请输入有效的 M3U8 URL');
                return;
            }

            statusEl.textContent = '加载 FFmpeg...';
            convertBtn.disabled = true;
            progressEl.style.display = 'block';
            progressBarEl.style.width = '0%';
            downloadLink.style.display = 'none';

            try {
                // 加载 FFmpeg（使用稳定 CDN）
                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
                    wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm'
                });
                statusEl.textContent = '下载视频流...';

                // 下载 M3U8（处理 CORS）
                const response = await fetch(m3u8Url);
                if (!response.ok) {
                    throw new Error(`HTTP 错误: ${response.status} - 检查 URL 是否有效`);
                }
                const data = await response.arrayBuffer();
                await ffmpeg.writeFile('input.m3u8', new Uint8Array(data));

                // 执行转换（快速复制模式）
                statusEl.textContent = '转换中...';
                await ffmpeg.exec(['-i', 'input.m3u8', '-c', 'copy', '-bsf:a', 'aac_adtstoasc', 'output.mp4']);

                // 读取并创建下载
                const fileData = await ffmpeg.readFile('output.mp4');
                const blob = new Blob([fileData.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = `converted-${Date.now()}.mp4`;
                downloadLink.textContent = '点击下载 MP4 文件';
                downloadLink.style.display = 'block';
                statusEl.textContent = '转换完成！';

            } catch (error) {
                let errorMsg = error.message;
                if (errorMsg.includes('CORS')) {
                    errorMsg += ' - 尝试使用支持 CORS 的代理或检查源站设置。';
                } else if (errorMsg.includes('fetch')) {
                    errorMsg += ' - 检查网络连接或 URL 访问权限。';
                }
                statusEl.textContent = `转换失败: ${errorMsg}`;
                console.error(error);
            } finally {
                convertBtn.disabled = false;
                progressEl.style.display = 'none';
            }
        });
    </script>
</body>
</html>
