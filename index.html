<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>M3U8 → MP4 转换（纯前端）</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>
<body>
<h2>M3U8 → MP4 在线转换</h2>
<input type="text" id="url" size="80" value="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8">
<button id="start">开始转换</button>
<p id="status"></p>
<a id="download" style="display:none;">下载 MP4</a>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

document.getElementById('start').onclick = async () => {
  const m3u8 = document.getElementById('url').value.trim();
  const status = document.getElementById('status');
  const download = document.getElementById('download');

  try {
    status.textContent = '加载 ffmpeg.wasm...';
    if (!ffmpeg.isLoaded()) await ffmpeg.load();

    status.textContent = '下载 m3u8 文件...';
    const m3u8Resp = await fetch(m3u8);
    if (!m3u8Resp.ok) throw new Error('m3u8 获取失败');
    const m3u8Data = await m3u8Resp.arrayBuffer();
    ffmpeg.FS('writeFile', 'input.m3u8', new Uint8Array(m3u8Data));

    status.textContent = '开始转换...';
    await ffmpeg.run('-protocol_whitelist','file,http,https,tcp,tls,crypto','-i','input.m3u8','-c','copy','output.mp4');

    status.textContent = '读取输出文件...';
    const data = ffmpeg.FS('readFile','output.mp4');
    const blob = new Blob([data.buffer], { type: 'video/mp4' });
    const url = URL.createObjectURL(blob);

    download.href = url;
    download.download = 'video.mp4';
    download.textContent = '点击下载 MP4';
    download.style.display = 'block';
    status.textContent = '转换完成！';

  } catch (err) {
    status.textContent = '失败: ' + err.message;
    console.error(err);
  }
};
</script>
</body>
</html>
